<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>너에게 온 편지 | 성광교회 중등부 전도축제</title>
  <!-- Open Graph Meta Tags -->
  <meta property="og:title" content="너에게 온 편지 | 성광교회 중등부 전도축제">
  <meta property="og:description" content="성광교회 중등부에서 열리는 특별한 전도축제 '너에게 온 편지'에 여러분을 초대합니다! 자세한 내용을 지금 확인해보세요.">
  <meta property="og:image" content="images/og.png">
  <meta property="og:url" content="https://sungkwang-middle-school-ministry.vercel.app/">
  
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/stickers.css">
  <link rel="stylesheet" href="css/worship-section.css">
  <link rel="stylesheet" href="css/scroll-to-top.css">
  <link rel="stylesheet" href="css/sections.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <script charset="UTF-8" class="daum_roughmap_loader_script" src="https://ssl.daumcdn.net/dmaps/map_js_init/roughmapLoader.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* 모바일 우선 스타일 - 반응형 없이 모바일 레이아웃만 사용 */
    .max-w-md { max-width: 28rem; }
    
    /* 섹션 표시/숨김 관련 스타일 */
    .section-container {
      display: none;
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    
    .section-container.active {
      display: block;
      opacity: 1;
    }
    
    /* 네비게이션 스타일 */
    .main-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: white;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      padding: 10px 0;
    }
    
    .nav-items {
      display: flex;
      justify-content: space-around;
      align-items: center;
    }
    
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #666;
      text-decoration: none;
      font-size: 12px;
      padding: 5px 0;
    }
    
    .nav-item i {
      font-size: 20px;
      margin-bottom: 5px;
    }
    
    .nav-item.active {
      color: #ff8eb4;
    }
    
    /* 페이지 여백 조정 */
    body {
      padding-bottom: 70px; /* 네비게이션 바 높이만큼 여백 추가 */
    }
    
    /* 섹션 전환 애니메이션 */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease forwards;
    }
  </style>
</head>
<body>
  <!-- 맨 위로 올라가는 플로팅 버튼 -->
  <div class="scroll-to-top" id="scrollToTop">
    <i class="fas fa-arrow-up"></i>
  </div>

  <!-- 홈 섹션 -->
  <section class="section-container active" id="home-section">
    <div class="main-hero" id="home">
      <div class="main-hero-content">
        <!-- 첫화면 이미지 -->
        <img src="images/hero/첫화면.png" usemap="#image-map" alt="첫화면" class="chapter-image" style="max-width: 100%; margin-bottom: 1px;">

        <map name="image-map" id="image-map">
          <area alt="편지읽어보기" title="편지읽어보기" href="#" coords="435,2626,1099,2488" shape="rect" onclick="showSection('letter-section'); return false;">
          <area alt="축제 둘러보기" title="축제 둘러보기" href="#" coords="1133,2804,424,2657,1085,2598,1066,2755" shape="rect" onclick="showSection('ministry-section'); return false;">
        </map>
        
        <!-- 버튼 -->
        <!-- <div class="main-hero-buttons">
          <a href="#" class="main-hero-btn" onclick="showSection('letter-section'); return false;">편지 읽어보기</a>
          <a href="#" class="main-hero-btn" onclick="showSection('ministry-section'); return false;">잔치 둘러보기</a>
        </div> -->
        
        <!-- 스티커 컨테이너 -->
        <div class="sticker-container">
          <!-- 스티커는 사용자가 직접 추가할 예정 -->
        </div>
      </div>
    </div>
  </section>

  <!-- 이벤트 섹션 -->
  <section class="section-container" id="event-section" style="text-align: center; padding: 20px;">
    <img src="images/그래서그날뭐해.png" usemap="#event-image-map" alt="그래서 그날 뭐해 이벤트 이미지" class="chapter-image" style="max-width: 100%;">
    <map name="event-image-map" id="event-image-map">
      <area alt="인스타그램" title="인스타그램" href="https://www.instagram.com/sungkwang_middleschool/" coords="1221,371,1299,468" data-original-coords="1221,371,1299,468" shape="rect" target="_blank">
      <area alt="유튜브" title="유튜브" href="https://www.youtube.com/@%EA%B5%AC%EB%A6%AC%EC%84%B1%EA%B4%91%EA%B5%90%ED%9A%8C%EC%A4%91%EB%93%B1%EB%B6%80/" coords="1361,385,1447,448" data-original-coords="1361,385,1447,448" shape="rect" target="_blank">
    </map>
  </section>

  <!-- 편지 섹션 -->
  <section class="section-container" id="letter-section">
    
    <!-- 그리스도의 편지 이미지 슬라이더 -->
    <div class="letter-slider-section">
      <div class="container">
        <div class="slider-container">
          <div class="letter-slider">            
            <!-- 원래 이미지들 - 번호 순서대로 -->
            <div class="letter-card" id="letter-1">
              <div class="letter-content">
                <img src="images/letter/1.png" alt="편지 이미지 1" class="letter-image">
              </div>
            </div>
            <div class="letter-card" id="letter-2">
              <div class="letter-content">
                <img src="images/letter/2.png" alt="편지 이미지 2" class="letter-image">
              </div>
            </div>
            <div class="letter-card" id="letter-3">
              <div class="letter-content">
                <img src="images/letter/3.png" alt="편지 이미지 3" class="letter-image">
              </div>
            </div>
            <div class="letter-card" id="letter-4">
              <div class="letter-content">
                <img src="images/letter/4.png" alt="편지 이미지 4" class="letter-image">
              </div>
            </div>
            <div class="letter-card" id="letter-5">
              <div class="letter-content">
                <img src="images/letter/5.png" alt="편지 이미지 5" class="letter-image">
              </div>
            </div>  
          </div>
          
        </div>
        <!-- Arrow buttons -->
        <div class="slider-controls">
          <button class="slider-btn prev-btn" id="prevLetterBtn" aria-label="Previous Letter">
            <i class="fas fa-chevron-left"></i>
          </button>
          <button class="slider-btn next-btn" id="nextLetterBtn" aria-label="Next Letter">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- 중등부 소개 섹션 -->
  <section class="section-container" id="ministry-section">
    
    <!-- 성광중등부 소개/홍보 섹션 -->
    <div class="ministry-info" style="margin: 0; padding: 0; width: 100%; max-width: 100%;">
      <!-- 우리의 예배 챕터 -->
      <div class="ministry-chapter our-worship">
        <img src="images/worship/우리의예배.png" alt="우리의 예배" class="chapter-image" usemap="#imgmap20255802323"> 
        <map id="imgmap20255802323" name="imgmap20255802323">
          <area shape="rect" alt="친구들" title="친구들" coords="328,1481,717,1698" href="https://youtube.com/shorts/__jXmnO0raI?feature=share" target="" />
        </map>
      </div>
      
      <!-- 우리의 성장 챕터 -->
      <div class="ministry-chapter our-growth">
        <img src="images/우리의성장.png" alt="우리의 성장" class="chapter-image">
      </div>
      
      <!-- 우리가 말하는 성광 중등부 챕터 -->
      <div class="ministry-chapter testimonials">
        <img src="images/우리가 말하는 성광 중등부.png" alt="우리가 말하는 성광 중등부" class="chapter-image">
      </div>
      
      <!-- 그래서 그 날 뭐해? 챕터 -->
      <div class="ministry-chapter what-we-do">
        <img src="images/그래서그날뭐해.png" alt="그래서 그날 뭐해?" class="chapter-image">
      </div>
    </div>
  </section>

  <!-- 오시는 길 섹션 -->
  <section class="section-container" id="location-section">
    
    <div class="location">
      <div class="container">
        <div class="location-content">
          <div class="map">
            <!-- 카카오맵 지도 -->
            <div id="daumRoughmapContainer1745679233203" class="root_daum_roughmap root_daum_roughmap_landing" style="width:100%; height:100%; margin-bottom:20px;"></div>
          </div>
          <div class="location-info">
            <h3>성광교회</h3>
            <p><i class="fas fa-map-marker-alt"></i> 11945 경기도 구리시 검배로 136번길 32(토평동) 성광교회</p>
            <p><i class="fas fa-clock"></i> 예배시간: 매주 일요일 오전 11시 20분</p>
            <p><i class="fas fa-phone"></i> TEL. 031-563-5210</p>
            <p><i class="fas fa-fax"></i> FAX. 031-553-1398</p>
            <p><i class="fas fa-envelope"></i> EMAIL. helpsk21church@gmail.com</p>
            <div style="margin-top:20px;">
              <a href="https://naver.me/xyTXM2o6" class="btn primary-btn" target="_blank" rel="noopener">네이버 지도</a>
              <a href="https://kko.kakao.com/pnT7w2c-cr" class="btn primary-btn" target="_blank" rel="noopener">카카오맵</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- 하단 네비게이션 바 -->
  <nav class="main-nav">
    <div class="nav-items">
      <a href="#" class="nav-item active" onclick="showSection('home-section'); return false;">
        <i class="fas fa-home"></i>
        <span>홈</span>
      </a>
      <a href="#" class="nav-item" onclick="showSection('letter-section'); return false;">
        <i class="fas fa-envelope"></i>
        <span>편지</span>
      </a>
      <a href="#" class="nav-item" onclick="showSection('ministry-section'); return false;">
        <i class="fas fa-church"></i>
        <span>중등부</span>
      </a>
      <a href="#" class="nav-item" onclick="showSection('location-section'); return false;">
        <i class="fas fa-map-marker-alt"></i>
        <span>오는 길</span>
      </a>
    </div>
  </nav>

  <script src="js/script.js" defer></script>
  <script src="js/stickers.js" defer></script>
  <script src="js/touch-swipe.js" defer></script>
  <script src="js/scroll-to-top.js" defer></script>
  
  <!-- 카카오맵 스크립트 -->
  <script charset="UTF-8">
    window.addEventListener('load', function() {
      setTimeout(function() {
        new daum.roughmap.Lander({
          "timestamp" : "1745679233203",
          "key" : "2nu85",
          "mapWidth" : "100%",
          "mapHeight" : "400"
        }).render();
      }, 1000);
    });
  </script>
  
  <!-- 섹션 전환 스크립트 -->
  <script>
    // 섹션 전환 함수
    function showSection(sectionId) {
      // All your existing code to hide current sections and update nav items...
      const sections = document.querySelectorAll('.section-container');
      sections.forEach(section => {
          section.classList.remove('active');
      });
  
      const targetSection = document.getElementById(sectionId);
      if (targetSection) { // Check if targetSection exists
          targetSection.classList.add('active');
          targetSection.classList.add('fade-in'); // Your animation class
  
          // Update navigation item active state (your existing logic)
          const navItems = document.querySelectorAll('.nav-item');
          navItems.forEach(item => {
              item.classList.remove('active');
          });
          const activeNavItem = document.querySelector(`.nav-item[onclick*="${sectionId}"]`);
          if (activeNavItem) {
              activeNavItem.classList.add('active');
          }
  
          window.scrollTo(0, 0); // Scroll to top
  
          // CRITICAL: Call map resizing functions after a short delay
          // This allows the DOM to update and images to have dimensions
          setTimeout(() => {
              resizeImageMap(); // Update all generic image maps
  
              if (sectionId === 'event-section') {
                  updateEventImageMapCoordinates(); // Specifically update the event map
              }
              // Your existing logic for letter-slider and location-section map re-render
              if (sectionId === 'letter-section') {
                  if (typeof initLetterSlider === 'function') {
                      // setTimeout(() => { initLetterSlider(); }, 100); // Your original delay
                      initLetterSlider(); // May not need separate timeout if already in one
                  }
              }
              if (sectionId === 'location-section') {
                  // setTimeout(() => { /* your daum map render logic */ }, 100); // Your original delay
                  if (typeof daum !== 'undefined' && typeof daum.roughmap !== 'undefined') {
                      new daum.roughmap.Lander({
                          "timestamp" : "1745679233203", // Use your actual timestamp
                          "key" : "2nu85",           // Use your actual key
                          "mapWidth" : "100%",
                          "mapHeight" : "100%"       // Or your desired height
                      }).render();
                  }
              }
          }, 100); // 100ms delay, adjust if needed
      }
  }
    
    // 페이지 로드 시 초기 섹션 설정
    document.addEventListener('DOMContentLoaded', function() {
      // URL 해시에 따라 초기 섹션 결정
      const hash = window.location.hash.substring(1);
      if (hash) {
        const sectionId = hash + '-section';
        if (document.getElementById(sectionId)) {
          showSection(sectionId);
        }
      }
    });
    // Place this function in the global scope or ensure it's accessible
    function updateEventImageMapCoordinates() {
      const imageMap = document.querySelector('map[name="event-image-map"]');
      if (!imageMap) return;

      const imageForMap = document.querySelector('img[usemap="#event-image-map"]');
      // Check if imageForMap exists and is loaded
      if (!imageForMap || !imageForMap.complete || imageForMap.naturalWidth === 0) {
          if(imageForMap) {
              // If not loaded, try again once it loads
              imageForMap.onload = updateEventImageMapCoordinates;
          }
          return;
      }

      const areas = imageMap.querySelectorAll('area');
      const originalImageWidth = 1608; // As per your specific script for this map

      const currentImageWidth = imageForMap.clientWidth;
      if (currentImageWidth === 0) return; // Image is not visible or has no width

      const scaleRatio = currentImageWidth / originalImageWidth;

      areas.forEach(area => {
          if (!area.dataset.originalCoords) {
              // Ensure originalCoords are stored if not already
              area.dataset.originalCoords = area.coords;
          }
          const originalCoordsArray = area.dataset.originalCoords.split(',').map(Number);
          // Ensure it's a rect, as per original code context (4 coords)
          if (originalCoordsArray.length !== 4) return; 

          const newCoordsArray = originalCoordsArray.map(coord => Math.round(coord * scaleRatio));
          area.coords = newCoordsArray.join(',');
      });
    }

    // Your existing DOMContentLoaded for event-image-map can now use this global function
    document.addEventListener('DOMContentLoaded', function() {
      const imageForMap = document.querySelector('img[usemap="#event-image-map"]');
      if (imageForMap) {
          if (imageForMap.complete && imageForMap.naturalWidth !== 0) {
              updateEventImageMapCoordinates();
          } else {
              imageForMap.addEventListener('load', updateEventImageMapCoordinates);
          }
      }
      // Keep the resize listener
      window.addEventListener('resize', updateEventImageMapCoordinates);
    });

    // Your existing generic resizeImageMap function (ensure it handles unloaded images gracefully)
    function resizeImageMap() {
      document.querySelectorAll('img[usemap]').forEach(function(img) {
          const mapName = img.getAttribute('usemap').replace('#', '');
          // Skip event-image-map if it's handled by its dedicated function
          if (mapName === 'event-image-map') {
              return; 
          }

          const processThisImg = (currentImg) => {
              const currentMapName = currentImg.getAttribute('usemap').replace('#', '');
              const map = document.querySelector('map[name="' + currentMapName + '"]');
              if (!map) return;

              // Ensure image is loaded and visible
              if (currentImg.naturalWidth === 0 || currentImg.clientWidth === 0) {
                  return;
              }

              const originalWidth = currentImg.naturalWidth;
              const originalHeight = currentImg.naturalHeight;
              const currentWidth = currentImg.clientWidth;
              const currentHeight = currentImg.clientHeight;
              const widthRatio = currentWidth / originalWidth;
              const heightRatio = currentHeight / originalHeight;

              map.querySelectorAll('area').forEach(function(area) {
                  const originalCoords = area.dataset.originalCoords || area.getAttribute('coords');
                  if (!area.dataset.originalCoords) {
                      area.dataset.originalCoords = originalCoords;
                  }
                  const coords = originalCoords.split(',').map(Number);
                  let newCoords = [];
                  const shape = area.getAttribute('shape').toLowerCase();
                  
                  if (shape === 'rect') {
                      newCoords = [
                          Math.round(coords[0] * widthRatio),
                          Math.round(coords[1] * heightRatio),
                          Math.round(coords[2] * widthRatio),
                          Math.round(coords[3] * heightRatio)
                      ];
                  } else if (shape === 'circle') {
                      newCoords = [
                          Math.round(coords[0] * widthRatio),
                          Math.round(coords[1] * heightRatio),
                          Math.round(coords[2] * widthRatio) // Assuming radius scales primarily with width
                      ];
                  } else if (shape === 'poly') {
                      newCoords = coords.map((val, idx) =>
                          idx % 2 === 0 ? Math.round(val * widthRatio) : Math.round(val * heightRatio)
                      );
                  }

                  if (newCoords.length > 0) {
                      area.setAttribute('coords', newCoords.join(','));
                  }
              });
          };

          if (!img.complete || img.naturalWidth === 0) {
              img.onload = () => processThisImg(img);
          } else {
              processThisImg(img);
          }
      });
    }
    // Keep these original listeners
    window.addEventListener('load', resizeImageMap);
    window.addEventListener('resize', resizeImageMap);

    // Letter Slider Navigation
    document.addEventListener('DOMContentLoaded', function() {
      const sliderContainer = document.querySelector('.letter-slider-section .slider-container');
      const prevBtn = document.getElementById('prevLetterBtn');
      const nextBtn = document.getElementById('nextLetterBtn');

      if (sliderContainer && prevBtn && nextBtn) {
        const scrollAmount = () => {
          return sliderContainer.clientWidth;
        };

        nextBtn.addEventListener('click', () => {
          sliderContainer.scrollBy({ left: scrollAmount(), behavior: 'smooth' });
        });

        prevBtn.addEventListener('click', () => {
          sliderContainer.scrollBy({ left: -scrollAmount(), behavior: 'smooth' });
        });

        const updateButtonVisibility = () => {
          if (!sliderContainer.isScrollable) { 
              prevBtn.classList.add('hidden');
              nextBtn.classList.add('hidden');
              return;
          }
          prevBtn.classList.toggle('hidden', sliderContainer.scrollLeft <= 0);
          nextBtn.classList.toggle('hidden', sliderContainer.scrollLeft + sliderContainer.clientWidth >= sliderContainer.scrollWidth - 1);
        };
        
        Object.defineProperty(HTMLElement.prototype, 'isScrollable', {
            get: function () {
                return this.scrollWidth > this.clientWidth || this.scrollHeight > this.clientHeight;
            }
        });

        sliderContainer.addEventListener('scroll', updateButtonVisibility);
        window.addEventListener('resize', updateButtonVisibility); 
        // updateButtonVisibility(); // 직접 호출 대신 지연 호출 사용
        
        // Initial check after a short delay to allow layout to settle
        setTimeout(updateButtonVisibility, 100); // 100ms 지연 후 호출 (필요시 시간 조정)
      }
    });

    // Responsive Image Map
    document.addEventListener('DOMContentLoaded', function() {
      const imageMap = document.querySelector('map[name="event-image-map"]');
      if (!imageMap) return; // 이미치 맵이 없으면 실행 중단

      const imageForMap = document.querySelector('img[usemap="#event-image-map"]');
      if (!imageForMap) return; // 이미지가 없으면 실행 중단

      const areas = imageMap.querySelectorAll('area');
      const originalImageWidth = 1608; // 원본 이미지 너비 (제공된 값)

      function updateMapCoordinates() {
        if (!imageForMap.complete || imageForMap.naturalWidth === 0) { 
            imageForMap.onload = updateMapCoordinates;
            return;
        }

        const currentImageWidth = imageForMap.clientWidth;
        // 이미지가 화면에 표시되지 않으면 clientWidth가 0일 수 있음, 이때는 업데이트하지 않음
        if (currentImageWidth === 0) return;

        const scaleRatio = currentImageWidth / originalImageWidth;

        areas.forEach(area => {
          if (!area.dataset.originalCoords) {
            area.dataset.originalCoords = area.coords; 
          }
          
          const originalCoordsArray = area.dataset.originalCoords.split(',').map(Number);
          if (originalCoordsArray.length !== 4) return; // 유효한 좌표가 아니면 건너뜀

          const newCoordsArray = originalCoordsArray.map(coord => Math.round(coord * scaleRatio));
          area.coords = newCoordsArray.join(',');
        });
      }

      // 이미지가 이미 로드된 경우를 대비하여 초기 실행 시 이미지 로드 상태 확인
      if (imageForMap.complete && imageForMap.naturalWidth !== 0) {
        updateMapCoordinates();
      } else {
        imageForMap.addEventListener('load', updateMapCoordinates);
      }
      
      window.addEventListener('resize', updateMapCoordinates);
    });
  </script>
</body>
</html>
